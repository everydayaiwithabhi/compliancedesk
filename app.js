// ComplianceDesk - Complete App JS (All-in-one)
// Config
var CONFIG={GAS_URL:'',APP_NAME:'ComplianceDesk',VERSION:'1.0.0',WORKFLOW_STATES:['PendingData','DataReceived','ValidationFailed','ReadyToFile','Filed','Acknowledged'],WORKFLOW_COLORS:{PendingData:'#f59e0b',DataReceived:'#3b82f6',ValidationFailed:'#ef4444',ReadyToFile:'#8b5cf6',Filed:'#10b981',Acknowledged:'#059669'},WORKFLOW_LABELS:{PendingData:'Pending Data',DataReceived:'Data Received',ValidationFailed:'Validation Failed',ReadyToFile:'Ready to File',Filed:'Filed',Acknowledged:'Acknowledged'},CLIENT_TYPES:['Pvt Ltd','LLP','Proprietorship','Partnership','Trust/Society'],CATEGORIES:['GST','TDS','ROC','Company Law','Director','Income Tax','Audit'],CHANNELS:['WhatsApp','Email','SMS','Phone','In Person'],COMM_TYPES:['Reminder','Follow-up','Acknowledgment','Query','Update','Escalation']};
function isConfigured(){return CONFIG.GAS_URL&&CONFIG.GAS_URL.length>10;}

// Validators
var Validators={
  PAN:function(p){return /^[A-Z]{5}[0-9]{4}[A-Z]$/.test(String(p||'').toUpperCase());},
  GSTIN:function(g){if(!g)return true;return /^\d{2}[A-Z]{5}\d{4}[A-Z]\d[Z][A-Z\d]$/.test(String(g).toUpperCase());},
  CIN:function(c){if(!c)return true;return /^[UL]\d{5}[A-Z]{2}\d{4}[A-Z]{3}\d{6}$/.test(String(c).toUpperCase());},
  DIN:function(d){if(!d)return true;return /^\d{8}$/.test(String(d));},
  email:function(e){return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||''));},
  phone:function(p){if(!p)return true;return /^[6-9]\d{9}$/.test(String(p));}
};

// App Controller
var currentPage='dashboard';
function navigateTo(page){currentPage=page;document.querySelectorAll('.nav-item').forEach(function(el){el.classList.toggle('active',el.dataset.page===page);});renderPage(page);}
function renderPage(page){var c=document.getElementById('pageContent');c.innerHTML='<div class="loading-screen"><div class="spinner"></div><p>Loading...</p></div>';try{switch(page){case 'dashboard':renderDashboard(c);break;case 'clients':renderClients(c);break;case 'calendar':renderCalendar(c);break;case 'workflow':renderWorkflow(c);break;case 'validation':renderValidation(c);break;case 'communications':renderCommunications(c);break;case 'settings':renderSettings(c);break;default:c.innerHTML='<h1>Not found</h1>';}}catch(e){c.innerHTML='<div class="info-box danger"><div class="ib-title">Error</div><div class="ib-text">'+e.message+'</div></div>';console.error(e);}}
function openModal(t,h){document.getElementById('modalTitle').textContent=t;document.getElementById('modalBody').innerHTML=h;document.getElementById('modalOverlay').style.display='flex';}
function closeModal(){document.getElementById('modalOverlay').style.display='none';}
function showToast(m,t){t=t||'info';var c=document.getElementById('toastContainer'),d=document.createElement('div');d.className='toast '+t;d.textContent=m;c.appendChild(d);setTimeout(function(){d.remove();},4000);}
function statusBadge(s){var m={PendingData:'badge-pending',DataReceived:'badge-received',ValidationFailed:'badge-failed',ReadyToFile:'badge-ready',Filed:'badge-filed',Acknowledged:'badge-ack'};return '<span class="badge '+(m[s]||'')+'"><span class="dot"></span>'+(CONFIG.WORKFLOW_LABELS[s]||s)+'</span>';}
function daysLeft(dl){if(!dl)return{days:0,label:'No date',cls:''};var n=new Date();n.setHours(0,0,0,0);var d=new Date(dl),diff=Math.ceil((d-n)/86400000);if(diff<0)return{days:diff,label:Math.abs(diff)+'d overdue',cls:'overdue'};if(diff<=3)return{days:diff,label:diff+'d left',cls:'due-soon'};return{days:diff,label:diff+'d left',cls:''};}
function formatDate(ds){if(!ds)return '-';return new Date(ds).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});}
function updateConnectionStatus(){var el=document.getElementById('connectionStatus');if(isConfigured())el.innerHTML='<span class="status-dot online"></span><span>Connected to Sheets</span>';else el.innerHTML='<span class="status-dot offline"></span><span>Demo Mode (Local)</span>';}

// Storage
var _s={get:function(k){try{return JSON.parse(localStorage.getItem('cd_'+k));}catch(e){return null;}},set:function(k,v){localStorage.setItem('cd_'+k,JSON.stringify(v));}};
var MONTH_NAMES=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
var COMP_T={'Pvt Ltd':[{n:'GSTR-1',f:'Monthly',d:11,c:'GST'},{n:'GSTR-3B',f:'Monthly',d:20,c:'GST'},{n:'TDS Return (24Q)',f:'Quarterly',d:31,c:'TDS'},{n:'ROC MGT-7',f:'Annually',mo:11,d:30,c:'ROC'},{n:'ROC AOC-4',f:'Annually',mo:10,d:30,c:'ROC'},{n:'Board Meeting',f:'Quarterly',d:30,c:'Company Law'},{n:'DIR-3 KYC',f:'Annually',mo:9,d:30,c:'Director'},{n:'Income Tax Return',f:'Annually',mo:10,d:31,c:'Income Tax'}],LLP:[{n:'GSTR-1',f:'Monthly',d:11,c:'GST'},{n:'GSTR-3B',f:'Monthly',d:20,c:'GST'},{n:'LLP Form 11',f:'Annually',mo:5,d:30,c:'ROC'},{n:'LLP Form 8',f:'Annually',mo:10,d:30,c:'ROC'},{n:'Income Tax Return',f:'Annually',mo:10,d:31,c:'Income Tax'}],Proprietorship:[{n:'GSTR-1',f:'Monthly',d:11,c:'GST'},{n:'GSTR-3B',f:'Monthly',d:20,c:'GST'},{n:'Income Tax Return',f:'Annually',mo:7,d:31,c:'Income Tax'}],Partnership:[{n:'GSTR-1',f:'Monthly',d:11,c:'GST'},{n:'GSTR-3B',f:'Monthly',d:20,c:'GST'},{n:'Income Tax Return',f:'Annually',mo:7,d:31,c:'Income Tax'},{n:'TDS Return',f:'Quarterly',d:31,c:'TDS'}],'Trust/Society':[{n:'GSTR-1',f:'Monthly',d:11,c:'GST'},{n:'GSTR-3B',f:'Monthly',d:20,c:'GST'},{n:'Income Tax Return',f:'Annually',mo:10,d:31,c:'Income Tax'}]};

function genId(){return Math.random().toString(36).substr(2,8);}
function genComps(cid,cn,ct){var ts=COMP_T[ct]||[],comps=_s.get('compliances')||[],now=new Date(),cnt=0,sts=['PendingData','DataReceived','ReadyToFile','Filed','Acknowledged'],asgn=['Ravi','Meena','Suresh'];ts.forEach(function(t){var ps=[];if(t.f==='Monthly'){for(var m=0;m<3;m++){var dl=new Date(now.getFullYear(),now.getMonth()+m+1,t.d);ps.push({dl:dl.toISOString().split('T')[0],p:MONTH_NAMES[(now.getMonth()+m)%12]+' '+now.getFullYear()});}}else if(t.f==='Quarterly'){var cq=Math.floor(now.getMonth()/3);for(var q=0;q<2;q++){var qm=((cq+q)%4)*3+2,yr=now.getFullYear()+(cq+q>=4?1:0);ps.push({dl:new Date(yr,qm,t.d).toISOString().split('T')[0],p:'Q'+((cq+q)%4+1)+' '+yr});}}else{var mn=(t.mo||3)-1,yr2=mn<now.getMonth()?now.getFullYear()+1:now.getFullYear();ps.push({dl:new Date(yr2,mn,t.d).toISOString().split('T')[0],p:'FY '+(yr2-1)+'-'+String(yr2).slice(2)});}ps.forEach(function(p){comps.push({ID:genId(),ClientID:cid,ClientName:cn,Name:t.n,Category:t.c,Frequency:t.f,Deadline:p.dl,Status:sts[Math.floor(Math.random()*sts.length)],AssignedTo:asgn[Math.floor(Math.random()*3)],FilingDate:'',AckNumber:'',Notes:'',Period:p.p,CreatedAt:new Date().toISOString(),UpdatedAt:new Date().toISOString()});cnt++;});});_s.set('compliances',comps);return cnt;}

function initDemo(){_s.set('_init',true);_s.set('clients',[]);_s.set('compliances',[]);_s.set('communications',[]);var ds=[{ln:'Sharma Enterprises Pvt Ltd',pan:'ABCDS1234E',gst:'27ABCDS1234E1Z5',cin:'U72200MH2020PTC123456',ty:'Pvt Ltd',cn:'Rajesh Sharma',em:'rajesh@sharmaent.com',ph:'9876543210'},{ln:'Gupta Trading LLP',pan:'AACFG5678H',gst:'07AACFG5678H1ZR',cin:'',ty:'LLP',cn:'Amit Gupta',em:'amit@guptatrading.in',ph:'9812345678'},{ln:'Priya Fashions',pan:'BKMPF9012L',gst:'29BKMPF9012L1ZQ',cin:'',ty:'Proprietorship',cn:'Priya Reddy',em:'priya@priyafashions.com',ph:'9988776655'}];ds.forEach(function(d){apiCreateClient({legalName:d.ln,pan:d.pan,gstin:d.gst,cin:d.cin,clientType:d.ty,contactName:d.cn,email:d.em,phone:d.ph});});}
function ensureInit(){if(!_s.get('_init'))initDemo();}

// CRUD
function apiCreateClient(d){var cls=_s.get('clients')||[],errs=[];if(!d.legalName)errs.push('Legal name required');if(!d.pan||!Validators.PAN(d.pan))errs.push('Invalid PAN');if(d.gstin&&!Validators.GSTIN(d.gstin))errs.push('Invalid GSTIN');if(d.gstin&&cls.some(function(c){return c.GSTIN===d.gstin.toUpperCase();}))errs.push('Duplicate GSTIN');if(d.pan&&cls.some(function(c){return c.PAN===d.pan.toUpperCase();}))errs.push('Duplicate PAN');if(!d.email||!Validators.email(d.email))errs.push('Invalid email');if(errs.length)return{success:false,errors:errs};var id=genId();cls.push({ID:id,LegalName:d.legalName,PAN:d.pan.toUpperCase(),GSTIN:d.gstin?d.gstin.toUpperCase():'',CIN:d.cin?d.cin.toUpperCase():'',ClientType:d.clientType,ContactName:d.contactName||'',Email:d.email,Phone:d.phone||'',Status:'Active',CreatedAt:new Date().toISOString(),UpdatedAt:new Date().toISOString()});_s.set('clients',cls);var cc=genComps(id,d.legalName,d.clientType);return{success:true,clientId:id,message:'Client created. '+cc+' compliances generated.',compliancesGenerated:cc};}
function apiUpdateClient(id,d){var cls=_s.get('clients')||[],idx=-1;for(var i=0;i<cls.length;i++)if(cls[i].ID===id){idx=i;break;}if(idx===-1)return{success:false,errors:['Not found']};if(d.legalName)cls[idx].LegalName=d.legalName;if(d.pan)cls[idx].PAN=d.pan.toUpperCase();if(d.gstin!==undefined)cls[idx].GSTIN=(d.gstin||'').toUpperCase();if(d.cin!==undefined)cls[idx].CIN=(d.cin||'').toUpperCase();if(d.clientType)cls[idx].ClientType=d.clientType;if(d.contactName!==undefined)cls[idx].ContactName=d.contactName;if(d.email)cls[idx].Email=d.email;if(d.phone!==undefined)cls[idx].Phone=d.phone;cls[idx].UpdatedAt=new Date().toISOString();_s.set('clients',cls);return{success:true};}
function apiUpdateComp(id,d){var cs=_s.get('compliances')||[],idx=-1;for(var i=0;i<cs.length;i++)if(cs[i].ID===id){idx=i;break;}if(idx===-1)return{success:false,errors:['Not found']};if(d.status){var ci=CONFIG.WORKFLOW_STATES.indexOf(cs[idx].Status),ni=CONFIG.WORKFLOW_STATES.indexOf(d.status);if(ni>ci+1)return{success:false,errors:['Cannot skip stages']};if(d.status==='Filed'&&!d.filingDate&&!cs[idx].FilingDate)return{success:false,errors:['Filing date required']};cs[idx].Status=d.status;}if(d.assignedTo!==undefined)cs[idx].AssignedTo=d.assignedTo;if(d.filingDate)cs[idx].FilingDate=d.filingDate;if(d.ackNumber)cs[idx].AckNumber=d.ackNumber;if(d.notes!==undefined)cs[idx].Notes=d.notes;cs[idx].UpdatedAt=new Date().toISOString();_s.set('compliances',cs);return{success:true};}
function apiLogComm(d){var cs=_s.get('communications')||[];cs.push({ID:genId(),ClientID:d.clientId,ClientName:d.clientName||'',Type:d.type||'Note',Channel:d.channel||'Manual',Message:d.message,SentAt:new Date().toISOString(),SentBy:'You'});_s.set('communications',cs);return{success:true};}
function getClients(){ensureInit();return _s.get('clients')||[];}
function getComps(f){ensureInit();var c=_s.get('compliances')||[];if(f&&f.clientId)c=c.filter(function(x){return x.ClientID===f.clientId;});return c;}
function getComms(cid){ensureInit();var c=_s.get('communications')||[];if(cid)c=c.filter(function(x){return x.ClientID===cid;});return c.reverse();}

// Dashboard Data
function getDash(){ensureInit();var cls=getClients(),cs=getComps(),td=new Date().toISOString().split('T')[0],n7=new Date(Date.now()+7*86400000).toISOString().split('T')[0];var tot=cs.length,fil=cs.filter(function(c){return c.Status==='Filed'||c.Status==='Acknowledged';}).length,ov=cs.filter(function(c){return c.Deadline<td&&c.Status!=='Filed'&&c.Status!=='Acknowledged';}).length,pd=cs.filter(function(c){return c.Status==='PendingData';}).length,dw=cs.filter(function(c){return c.Deadline>=td&&c.Deadline<=n7&&c.Status!=='Filed'&&c.Status!=='Acknowledged';}).length;var cats={};cs.forEach(function(c){if(!cats[c.Category])cats[c.Category]={total:0,filed:0,overdue:0};cats[c.Category].total++;if(c.Status==='Filed'||c.Status==='Acknowledged')cats[c.Category].filed++;if(c.Deadline<td&&c.Status!=='Filed'&&c.Status!=='Acknowledged')cats[c.Category].overdue++;});var csm=cls.map(function(cl){var cc=cs.filter(function(c){return c.ClientID===cl.ID;});return{id:cl.ID,name:cl.LegalName,type:cl.ClientType,total:cc.length,filed:cc.filter(function(c){return c.Status==='Filed'||c.Status==='Acknowledged';}).length,overdue:cc.filter(function(c){return c.Deadline<td&&c.Status!=='Filed'&&c.Status!=='Acknowledged';}).length,pending:cc.filter(function(c){return c.Status==='PendingData';}).length};});var up=cs.filter(function(c){return c.Status!=='Filed'&&c.Status!=='Acknowledged';}).sort(function(a,b){return(a.Deadline||'').localeCompare(b.Deadline||'');}).slice(0,10);return{stats:{total:tot,filed:fil,overdue:ov,pendingData:pd,dueThisWeek:dw,clientCount:cls.length},categories:cats,clientSummary:csm,upcoming:up};}

// DASHBOARD
function renderDashboard(el){var d=getDash(),s=d.stats,today=new Date().toLocaleDateString('en-IN',{weekday:'long',year:'numeric',month:'long',day:'numeric'});var h='<div class="page-header"><div><h1>Dashboard</h1><div class="subtitle">'+today+'</div></div></div><div class="stat-grid"><div class="stat-card" style="background:#eff6ff"><div class="stat-value" style="color:#3b82f6">'+s.total+'</div><div class="stat-label" style="color:#3b82f6">Total Compliances</div></div><div class="stat-card" style="background:#fef2f2"><div class="stat-value" style="color:#ef4444">'+s.overdue+'</div><div class="stat-label" style="color:#ef4444">Overdue</div></div><div class="stat-card" style="background:#fffbeb"><div class="stat-value" style="color:#f59e0b">'+s.dueThisWeek+'</div><div class="stat-label" style="color:#f59e0b">Due This Week</div></div><div class="stat-card" style="background:#ecfdf5"><div class="stat-value" style="color:#10b981">'+s.filed+'</div><div class="stat-label" style="color:#10b981">Filed</div></div><div class="stat-card" style="background:#f5f3ff"><div class="stat-value" style="color:#8b5cf6">'+s.pendingData+'</div><div class="stat-label" style="color:#8b5cf6">Pending Data</div></div><div class="stat-card" style="background:#ecfeff"><div class="stat-value" style="color:#06b6d4">'+s.clientCount+'</div><div class="stat-label" style="color:#06b6d4">Active Clients</div></div></div>';h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px"><div class="card"><div class="card-title">Upcoming Deadlines</div>';d.upcoming.forEach(function(c){var dl=daysLeft(c.Deadline),col=dl.cls==='overdue'?'#ef4444':dl.cls==='due-soon'?'#f59e0b':'#6b7280';h+='<div class="deadline-item '+dl.cls+'"><div><div style="font-size:13px;font-weight:600">'+c.Name+'</div><div style="font-size:11px;color:#6b7280">'+c.ClientName+'</div></div><div style="text-align:right"><div style="font-size:12px;font-weight:700;color:'+col+'">'+dl.label+'</div><div style="font-size:11px;color:#9ca3af">'+c.Deadline+'</div></div></div>';});if(!d.upcoming.length)h+='<p style="color:#9ca3af;font-size:13px">All caught up!</p>';h+='</div><div class="card"><div class="card-title">Category Completion</div>';Object.keys(d.categories).forEach(function(nm){var x=d.categories[nm],pct=x.total?Math.round(x.filed/x.total*100):0;h+='<div style="margin-bottom:12px"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:13px;font-weight:600">'+nm+'</span><span style="font-size:12px;color:#6b7280">'+x.filed+'/'+x.total+(x.overdue>0?' <span style="color:#ef4444">('+x.overdue+' overdue)</span>':'')+'</span></div><div class="progress-bar"><div class="progress-fill" style="width:'+pct+'%;background:'+(x.overdue>0?'linear-gradient(90deg,#10b981,#f59e0b)':'#10b981')+'"></div></div></div>';});h+='</div></div>';h+='<div class="card" style="margin-top:16px"><div class="card-title">Client Summary</div><div class="table-container" style="border:none"><table class="data-table"><thead><tr><th>Client</th><th>Type</th><th>Total</th><th>Filed</th><th>Pending</th><th>Overdue</th><th>%</th></tr></thead><tbody>';d.clientSummary.forEach(function(c){var pct=c.total?Math.round(c.filed/c.total*100):0,col=pct>=70?'#10b981':pct>=40?'#f59e0b':'#ef4444';h+='<tr><td style="font-weight:600">'+c.name+'</td><td><span class="tag">'+c.type+'</span></td><td style="font-weight:600">'+c.total+'</td><td style="color:#10b981;font-weight:600">'+c.filed+'</td><td style="color:#f59e0b;font-weight:600">'+c.pending+'</td><td style="color:#ef4444;font-weight:600">'+c.overdue+'</td><td><div style="display:flex;align-items:center;gap:8px"><div class="progress-bar" style="flex:1"><div class="progress-fill" style="width:'+pct+'%;background:'+col+'"></div></div><span style="font-size:12px;font-weight:700">'+pct+'%</span></div></td></tr>';});h+='</tbody></table></div></div>';el.innerHTML=h;}

// CLIENTS
function renderClients(el){var cls=getClients(),cs=getComps();window._cls=cls;window._cs=cs;el.innerHTML='<div class="page-header"><div><h1>Clients</h1><div class="subtitle">'+cls.length+' registered</div></div><button class="btn btn-primary" onclick="showClientForm()">+ Add Client</button></div><div class="search-box"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input class="form-input" id="cSearch" placeholder="Search..." oninput="filterCl()"></div><div id="cList"></div>';filterCl();}
function filterCl(){var t=(document.getElementById('cSearch')?document.getElementById('cSearch').value:'').toLowerCase(),cls=window._cls||[],cs=window._cs||[],td=new Date().toISOString().split('T')[0],h='';cls.filter(function(c){return[c.LegalName,c.PAN,c.GSTIN,c.ClientType].some(function(f){return(f||'').toLowerCase().indexOf(t)>=0;});}).forEach(function(cl){var cc=cs.filter(function(c){return c.ClientID===cl.ID;}),ov=cc.filter(function(c){return c.Deadline<td&&c.Status!=='Filed'&&c.Status!=='Acknowledged';}).length;h+='<div class="client-row" onclick="showClientForm(\''+cl.ID+'\')"><div style="flex:1"><div style="display:flex;align-items:center;gap:10px;margin-bottom:4px"><span style="font-size:15px;font-weight:700">'+cl.LegalName+'</span><span class="tag">'+cl.ClientType+'</span></div><div style="display:flex;gap:20px;font-size:12px;color:#6b7280"><span>PAN: '+cl.PAN+'</span>'+(cl.GSTIN?'<span>GSTIN: '+cl.GSTIN+'</span>':'')+'</div></div><div style="display:flex;align-items:center;gap:16px"><div style="text-align:right"><div style="font-size:13px;font-weight:600">'+cc.length+' compliances</div>'+(ov>0?'<div style="font-size:12px;font-weight:600;color:#ef4444">'+ov+' overdue</div>':'')+'</div></div></div>';});document.getElementById('cList').innerHTML=h||'<p style="text-align:center;padding:40px;color:#9ca3af">No clients found</p>';}
function showClientForm(eid){var cls=window._cls||[],cl=eid?cls.find(function(c){return c.ID===eid;}):null,to=CONFIG.CLIENT_TYPES.map(function(t){return'<option value="'+t+'"'+(cl&&cl.ClientType===t?' selected':'')+'>'+t+'</option>';}).join('');openModal(cl?'Edit Client':'Add Client','<div class="form-row"><div class="form-full form-group"><label class="form-label">Legal Name <span class="required">*</span></label><input class="form-input" id="cf_ln" value="'+(cl?cl.LegalName:'')+'"><div class="form-error" id="e_ln"></div></div></div><div class="form-row"><div class="form-group"><label class="form-label">Type <span class="required">*</span></label><select class="form-input" id="cf_ty">'+to+'</select></div><div class="form-group"><label class="form-label">PAN <span class="required">*</span></label><input class="form-input" id="cf_pan" value="'+(cl?cl.PAN:'')+'" maxlength="10" oninput="this.value=this.value.toUpperCase()"><div class="form-error" id="e_pan"></div></div></div><div class="form-row"><div class="form-group"><label class="form-label">GSTIN</label><input class="form-input" id="cf_gst" value="'+(cl?cl.GSTIN:'')+'" maxlength="15" oninput="this.value=this.value.toUpperCase()"><div class="form-error" id="e_gst"></div></div><div class="form-group"><label class="form-label">CIN</label><input class="form-input" id="cf_cin" value="'+(cl?cl.CIN||'':'')+'" maxlength="21" oninput="this.value=this.value.toUpperCase()"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Contact</label><input class="form-input" id="cf_cn" value="'+(cl?cl.ContactName:'')+'"></div><div class="form-group"><label class="form-label">Email <span class="required">*</span></label><input class="form-input" id="cf_em" value="'+(cl?cl.Email:'')+'"><div class="form-error" id="e_em"></div></div></div><div class="form-row"><div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="cf_ph" value="'+(cl?cl.Phone:'')+'" maxlength="10"><div class="form-error" id="e_ph"></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="submitCl(\''+(eid||'')+'\')">'+(cl?'Update':'Add Client')+'</button></div>');}
function submitCl(eid){['ln','pan','gst','em','ph'].forEach(function(f){var e=document.getElementById('e_'+f);if(e)e.textContent='';});var d={legalName:document.getElementById('cf_ln').value.trim(),clientType:document.getElementById('cf_ty').value,pan:document.getElementById('cf_pan').value.trim(),gstin:document.getElementById('cf_gst').value.trim(),cin:document.getElementById('cf_cin').value.trim(),contactName:document.getElementById('cf_cn').value.trim(),email:document.getElementById('cf_em').value.trim(),phone:document.getElementById('cf_ph').value.trim()},err=false;function se(f,m){var e=document.getElementById('e_'+f);if(e)e.textContent=m;err=true;}if(!d.legalName)se('ln','Required');if(!d.pan)se('pan','Required');else if(!Validators.PAN(d.pan))se('pan','Invalid');if(d.gstin&&!Validators.GSTIN(d.gstin))se('gst','Invalid');if(!d.email)se('em','Required');else if(!Validators.email(d.email))se('em','Invalid');if(d.phone&&!Validators.phone(d.phone))se('ph','Invalid');if(err)return;var r=eid?apiUpdateClient(eid,d):apiCreateClient(d);if(r.success){closeModal();showToast(r.message||(eid?'Updated':'Created'),'success');renderClients(document.getElementById('pageContent'));}else(r.errors||[]).forEach(function(e){showToast(e,'error');});}

// CALENDAR
var _calF='all',_calC='all';
function renderCalendar(el){window._calCs=getComps();_calF='all';_calC='all';var cats=[];window._calCs.forEach(function(c){if(cats.indexOf(c.Category)<0)cats.push(c.Category);});el.innerHTML='<div class="page-header"><div><h1>Compliance Calendar</h1><div class="subtitle">'+window._calCs.length+' items</div></div></div><div class="filter-bar"><button class="filter-btn active" data-filter="all" onclick="setCalF(\'all\')">All</button><button class="filter-btn" data-filter="overdue" onclick="setCalF(\'overdue\')">Overdue</button><button class="filter-btn" data-filter="week" onclick="setCalF(\'week\')">Due This Week</button><button class="filter-btn" data-filter="pending" onclick="setCalF(\'pending\')">Pending</button><button class="filter-btn" data-filter="filed" onclick="setCalF(\'filed\')">Filed</button><select class="form-input" style="width:auto;padding:8px 12px;font-size:13px" onchange="setCalC(this.value)"><option value="all">All Categories</option>'+cats.map(function(c){return'<option value="'+c+'">'+c+'</option>';}).join('')+'</select></div><div class="table-container" id="calTbl"></div>';renderCalTbl();}
function setCalF(f){_calF=f;document.querySelectorAll('.filter-btn').forEach(function(e){e.classList.toggle('active',e.dataset.filter===f);});renderCalTbl();}
function setCalC(c){_calC=c;renderCalTbl();}
function renderCalTbl(){var all=window._calCs||[],td=new Date().toISOString().split('T')[0],n7=new Date(Date.now()+7*86400000).toISOString().split('T')[0],f=all;if(_calF==='overdue')f=f.filter(function(c){return c.Deadline<td&&c.Status!=='Filed'&&c.Status!=='Acknowledged';});if(_calF==='week')f=f.filter(function(c){return c.Deadline>=td&&c.Deadline<=n7&&c.Status!=='Filed'&&c.Status!=='Acknowledged';});if(_calF==='pending')f=f.filter(function(c){return c.Status==='PendingData';});if(_calF==='filed')f=f.filter(function(c){return c.Status==='Filed'||c.Status==='Acknowledged';});if(_calC!=='all')f=f.filter(function(c){return c.Category===_calC;});f.sort(function(a,b){return(a.Deadline||'').localeCompare(b.Deadline||'');});var h='<table class="data-table"><thead><tr><th>Client</th><th>Compliance</th><th>Category</th><th>Period</th><th>Deadline</th><th>Status</th><th>Assigned</th></tr></thead><tbody>';f.forEach(function(c){var dl=daysLeft(c.Deadline),ov=dl.cls==='overdue'&&c.Status!=='Filed'&&c.Status!=='Acknowledged',dc=ov?'#ef4444':dl.cls==='due-soon'?'#f59e0b':'#374151';h+='<tr style="background:'+(ov?'#fef2f2':'transparent')+'" onclick="showCompDtl(\''+c.ID+'\')"><td style="font-weight:600">'+c.ClientName+'</td><td>'+c.Name+'</td><td><span class="badge-sm" style="background:#f3f4f6">'+c.Category+'</span></td><td style="color:#6b7280">'+(c.Period||'')+'</td><td><span style="font-weight:600;color:'+dc+'">'+c.Deadline+'</span></td><td>'+statusBadge(c.Status)+'</td><td style="color:#6b7280">'+(c.AssignedTo||'-')+'</td></tr>';});h+='</tbody></table>';if(!f.length)h+='<p style="text-align:center;padding:40px;color:#9ca3af">No items</p>';document.getElementById('calTbl').innerHTML=h;}
function showCompDtl(id){var c=(window._calCs||[]).find(function(x){return x.ID===id;});if(!c)return;var sb=CONFIG.WORKFLOW_STATES.map(function(st,i){var ci=CONFIG.WORKFLOW_STATES.indexOf(c.Status),cur=st===c.Status,past=i<ci,col=CONFIG.WORKFLOW_COLORS[st];return'<button onclick="advComp(\''+id+'\',\''+st+'\')" style="flex:1;padding:8px 4px;border-radius:8px;font-size:10px;font-weight:700;cursor:pointer;background:'+(cur?col:past?col+'30':'#f3f4f6')+';color:'+(cur?'#fff':past?col:'#9ca3af')+';border:2px solid '+(cur?col:'transparent')+';font-family:inherit">'+CONFIG.WORKFLOW_LABELS[st]+'</button>';}).join('');openModal('Compliance Detail','<div class="form-row" style="margin-bottom:16px"><div><span style="font-size:11px;color:#6b7280;font-weight:600">CLIENT</span><div style="font-weight:700">'+c.ClientName+'</div></div><div><span style="font-size:11px;color:#6b7280;font-weight:600">COMPLIANCE</span><div style="font-weight:700">'+c.Name+'</div></div><div><span style="font-size:11px;color:#6b7280;font-weight:600">DEADLINE</span><div style="font-weight:600">'+c.Deadline+'</div></div><div><span style="font-size:11px;color:#6b7280;font-weight:600">STATUS</span><div>'+statusBadge(c.Status)+'</div></div></div><div style="margin-bottom:20px"><span style="font-size:12px;color:#6b7280;font-weight:600;display:block;margin-bottom:8px">WORKFLOW</span><div style="display:flex;gap:4px">'+sb+'</div></div><div class="form-row"><div class="form-group"><label class="form-label">Assigned To</label><input class="form-input" id="cd_at" value="'+(c.AssignedTo||'')+'"></div><div class="form-group"><label class="form-label">Filing Date</label><input class="form-input" type="date" id="cd_fd" value="'+(c.FilingDate||'')+'"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Ack Number</label><input class="form-input" id="cd_ack" value="'+(c.AckNumber||'')+'"></div></div><div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="cd_notes">'+(c.Notes||'')+'</textarea></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Close</button><button class="btn btn-primary" onclick="saveCompDtl(\''+id+'\')">Save</button></div>');}
function advComp(id,st){var fd=document.getElementById('cd_fd')?document.getElementById('cd_fd').value:'';var r=apiUpdateComp(id,{status:st,filingDate:fd});if(r.success){showToast('Updated','success');closeModal();window._calCs=getComps();renderCalTbl();}else showToast((r.errors||['Error']).join(', '),'error');}
function saveCompDtl(id){var r=apiUpdateComp(id,{assignedTo:document.getElementById('cd_at').value,filingDate:document.getElementById('cd_fd').value,ackNumber:document.getElementById('cd_ack').value,notes:document.getElementById('cd_notes').value});if(r.success){showToast('Saved','success');closeModal();window._calCs=getComps();renderCalTbl();}else showToast((r.errors||['Error']).join(', '),'error');}

// WORKFLOW BOARD
function renderWorkflow(el){var cs=getComps(),act=cs.filter(function(c){return c.Status!=='Filed'&&c.Status!=='Acknowledged';}),cols=CONFIG.WORKFLOW_STATES.filter(function(s){return s!=='Filed'&&s!=='Acknowledged';});var h='<div class="page-header"><div><h1>Workflow Board</h1><div class="subtitle">'+act.length+' active</div></div><button class="btn btn-secondary btn-sm" onclick="renderWorkflow(document.getElementById(\'pageContent\'))">Refresh</button></div><div class="workflow-board">';cols.forEach(function(st){var items=act.filter(function(c){return c.Status===st;}),col=CONFIG.WORKFLOW_COLORS[st];h+='<div class="workflow-column" style="background:'+col+'08;border-color:'+col+'20"><div class="workflow-column-header"><span class="col-dot" style="background:'+col+'"></span><span class="col-title">'+CONFIG.WORKFLOW_LABELS[st]+'</span><span class="col-count" style="background:'+col+'20;color:'+col+'">'+items.length+'</span></div>';items.forEach(function(c){var dl=daysLeft(c.Deadline),nxt=CONFIG.WORKFLOW_STATES[CONFIG.WORKFLOW_STATES.indexOf(st)+1],dc=dl.cls==='overdue'?'#ef4444':dl.cls==='due-soon'?'#f59e0b':'#6b7280',bg=dl.cls==='overdue'?'#fef2f2':dl.cls==='due-soon'?'#fffbeb':'#f3f4f6';h+='<div class="workflow-card"><div class="wc-name">'+c.Name+'</div><div class="wc-client">'+c.ClientName+'</div><div class="wc-footer"><span class="wc-days" style="background:'+bg+';color:'+dc+'">'+dl.label+'</span>'+(c.AssignedTo?'<span style="font-size:10px;color:#9ca3af">'+c.AssignedTo+'</span>':'')+'</div>';if(nxt&&nxt!=='Filed'&&nxt!=='Acknowledged')h+='<button class="wc-advance-btn" style="background:'+col+'15;color:'+col+'" onclick="advWf(\''+c.ID+'\',\''+nxt+'\')">Advance &rarr;</button>';h+='</div>';});if(!items.length)h+='<p style="text-align:center;font-size:11px;color:#9ca3af;padding:20px">Empty</p>';h+='</div>';});h+='</div>';el.innerHTML=h;}
function advWf(id,st){var r=apiUpdateComp(id,{status:st});if(r.success){showToast('Moved','success');renderWorkflow(document.getElementById('pageContent'));}else showToast((r.errors||['Error']).join(', '),'error');}

// VALIDATION
var _invs=[];
function renderValidation(el){_invs=[];el.innerHTML='<div class="page-header"><div><h1>Data Validation</h1><div class="subtitle">Validate Indian identifiers</div></div></div><div class="validation-grid"><div class="validation-card"><div class="vc-title">PAN</div><input class="form-input" id="v_pan" placeholder="ABCDE1234F" oninput="this.value=this.value.toUpperCase();vf(\'pan\')"><div class="validation-result neutral" id="vr_pan">5 letters + 4 digits + 1 letter</div></div><div class="validation-card"><div class="vc-title">GSTIN</div><input class="form-input" id="v_gstin" placeholder="27ABCDE1234F1Z5" oninput="this.value=this.value.toUpperCase();vf(\'gstin\')"><div class="validation-result neutral" id="vr_gstin">15 char alphanumeric</div></div><div class="validation-card"><div class="vc-title">CIN</div><input class="form-input" id="v_cin" placeholder="U72200MH2020PTC123456" oninput="this.value=this.value.toUpperCase();vf(\'cin\')"><div class="validation-result neutral" id="vr_cin">21 char company ID</div></div><div class="validation-card"><div class="vc-title">DIN</div><input class="form-input" id="v_din" placeholder="12345678" oninput="vf(\'din\')"><div class="validation-result neutral" id="vr_din">8 digit director ID</div></div></div><div class="card"><div class="card-title">Invoice Duplicate Checker</div><div style="display:flex;gap:8px;margin-bottom:14px"><input class="form-input" id="invIn" placeholder="Invoice number..." onkeydown="if(event.key===\'Enter\')chkInv()" style="flex:1"><button class="btn btn-primary" onclick="chkInv()">Check</button><button class="btn btn-secondary" onclick="_invs=[];document.getElementById(\'invR\').innerHTML=\'\'">Clear</button></div><div id="invR"></div></div>';}
function vf(f){var v=document.getElementById('v_'+f).value.trim(),el=document.getElementById('vr_'+f),hints={pan:'5 letters + 4 digits + 1 letter',gstin:'15 char alphanumeric',cin:'21 char company ID',din:'8 digit director ID'},map={pan:'PAN',gstin:'GSTIN',cin:'CIN',din:'DIN'};if(!v){el.className='validation-result neutral';el.textContent=hints[f];return;}var ok=Validators[map[f]](v);el.className='validation-result '+(ok?'valid':'invalid');el.textContent=ok?'Valid':'Invalid. Expected: '+hints[f];}
function chkInv(){var inp=document.getElementById('invIn'),n=inp.value.trim();if(!n)return;if(_invs.find(function(i){return i.n===n;})){showToast('Duplicate: '+n,'warning');}else{_invs.push({n:n});}inp.value='';inp.focus();var h='';_invs.forEach(function(i){h+='<span style="display:inline-block;padding:4px 12px;border-radius:8px;font-size:12px;font-weight:600;margin:2px;background:#ecfdf5;color:#059669;border:1px solid #bbf7d0">'+i.n+' âœ“</span>';});document.getElementById('invR').innerHTML=h;}

// COMMUNICATIONS
function renderCommunications(el){var comms=getComms(),cls=getClients();window._commCls=cls;var chC={WhatsApp:'#25d366',Email:'#3b82f6',SMS:'#8b5cf6',Phone:'#f59e0b','In Person':'#6b7280'},h='<div class="page-header"><div><h1>Communications</h1></div><button class="btn btn-primary" onclick="showCommForm()">+ Log</button></div>';comms.forEach(function(l){var cc=chC[l.Channel]||'#6b7280',tc=l.Type==='Reminder'?'#ef4444':l.Type==='Follow-up'?'#f59e0b':'#059669',tb=l.Type==='Reminder'?'#fef2f2':l.Type==='Follow-up'?'#fffbeb':'#ecfdf5';h+='<div class="comm-item"><div class="comm-icon" style="background:'+cc+'15;color:'+cc+'"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div><div style="flex:1"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-weight:700">'+l.ClientName+'</span><span style="font-size:12px;color:#9ca3af">'+formatDate(l.SentAt)+'</span></div><div style="display:flex;gap:8px;margin-bottom:6px"><span class="badge-sm" style="background:'+tb+';color:'+tc+'">'+l.Type+'</span><span class="badge-sm" style="background:'+cc+'15;color:'+cc+'">'+l.Channel+'</span></div><p style="font-size:13px;color:#4b5563;margin:0">'+l.Message+'</p></div></div>';});if(!comms.length)h+='<p style="text-align:center;padding:40px;color:#9ca3af">No communications yet</p>';el.innerHTML=h;}
function showCommForm(){var cls=window._commCls||[],co=cls.map(function(c){return'<option value="'+c.ID+'" data-name="'+c.LegalName+'">'+c.LegalName+'</option>';}).join(''),to=CONFIG.COMM_TYPES.map(function(t){return'<option>'+t+'</option>';}).join(''),cho=CONFIG.CHANNELS.map(function(c){return'<option>'+c+'</option>';}).join('');openModal('Log Communication','<div class="form-group"><label class="form-label">Client <span class="required">*</span></label><select class="form-input" id="cm_cl"><option value="">Select</option>'+co+'</select></div><div class="form-row"><div class="form-group"><label class="form-label">Type</label><select class="form-input" id="cm_ty">'+to+'</select></div><div class="form-group"><label class="form-label">Channel</label><select class="form-input" id="cm_ch">'+cho+'</select></div></div><div class="form-group"><label class="form-label">Message <span class="required">*</span></label><textarea class="form-input" id="cm_msg"></textarea></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="submitComm()">Log</button></div>');}
function submitComm(){var sel=document.getElementById('cm_cl'),msg=document.getElementById('cm_msg').value.trim();if(!sel.value||!msg){showToast('Client and message required','error');return;}apiLogComm({clientId:sel.value,clientName:sel.options[sel.selectedIndex].dataset.name||'',type:document.getElementById('cm_ty').value,channel:document.getElementById('cm_ch').value,message:msg});closeModal();showToast('Logged','success');renderCommunications(document.getElementById('pageContent'));}

// SETTINGS
function renderSettings(el){el.innerHTML='<div class="page-header"><div><h1>Settings</h1></div></div><div class="settings-section"><h3>Google Apps Script Connection</h3><div class="form-group"><label class="form-label">Web App URL</label><input class="form-input" id="set_url" value="'+(CONFIG.GAS_URL||'')+'" placeholder="https://script.google.com/macros/s/.../exec"><div class="form-hint">Deploy Apps Script as Web App, paste URL here</div></div><button class="btn btn-primary btn-sm" onclick="saveGas()">Save & Test</button><div id="connTest" style="margin-top:12px"></div></div><div class="settings-section"><h3>Demo Mode</h3><p style="font-size:13px;color:#6b7280;margin-bottom:12px">Running locally in your browser.</p><div style="display:flex;gap:10px"><button class="btn btn-secondary btn-sm" onclick="resetDemo()">Reset Demo Data</button><button class="btn btn-danger btn-sm" onclick="clearAll()">Clear All Data</button></div></div><div class="settings-section"><h3>About</h3><p style="font-size:13px;color:#6b7280;line-height:1.8">ComplianceDesk v'+CONFIG.VERSION+'<br>Stack: Static HTML/JS + Google Apps Script + Sheets<br>Cost: Free</p></div>';}
function saveGas(){var u=document.getElementById('set_url').value.trim();CONFIG.GAS_URL=u;updateConnectionStatus();document.getElementById('connTest').innerHTML=u?'<div class="info-box success"><div class="ib-text">URL saved. Connect to test with live data.</div></div>':'<div class="info-box warning"><div class="ib-text">URL cleared. Running in demo mode.</div></div>';}
function resetDemo(){if(!confirm('Reset demo data?'))return;Object.keys(localStorage).filter(function(k){return k.startsWith('cd_');}).forEach(function(k){localStorage.removeItem(k);});showToast('Reset. Refreshing...','success');setTimeout(function(){navigateTo('dashboard');},500);}
function clearAll(){if(!confirm('Clear ALL data?'))return;Object.keys(localStorage).filter(function(k){return k.startsWith('cd_');}).forEach(function(k){localStorage.removeItem(k);});showToast('Cleared','info');navigateTo('dashboard');}

// INIT
document.addEventListener('DOMContentLoaded',function(){updateConnectionStatus();navigateTo('dashboard');});
